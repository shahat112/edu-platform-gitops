            spec:
              containers:
              - name: app
                image: cr.yandex/${{ steps.lockbox.outputs.REGISTRY_ID }}/$IMAGE_NAME:${{ github.sha }}
                imagePullPolicy: Always
                ports:
                - containerPort: 80
                env:
                - name: POSTGRES_HOST
                  value: "${{ steps.lockbox.outputs.POSTGRES_HOST }}"
                - name: APP_VERSION
                  value: "${{ github.sha }}"
                - name: DEPLOYMENT_TIME
                  value: "$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
                resources:
                  requests:
                    memory: "64Mi"
                    cpu: "100m"
                  limits:
                    memory: "128Mi"
                    cpu: "200m"
                readinessProbe:
                  httpGet:
                    path: /health
                    port: 80
                  initialDelaySeconds: 5
                  periodSeconds: 10
                livenessProbe:
                  httpGet:
                    path: /health
                    port: 80
                  initialDelaySeconds: 15
                  periodSeconds: 20
        DEPLOYMENT
        
        kubectl apply -f deployment.yaml
        echo "âœ… Deployment applied"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ service
        cat > service.yaml << SERVICE
        apiVersion: v1
        kind: Service
        metadata:
          name: test-lockbox-service
          namespace: lockbox-demo
        spec:
          type: NodePort
          selector:
            app: test-lockbox-app
          ports:
          - port: 80
            targetPort: 80
            nodePort: 30090
        SERVICE
        
        kubectl apply -f service.yaml
        echo "âœ… Service applied"
    
    - name: Verify deployment
      run: |
        echo "ðŸ” Verifying deployment..."
        
        # Ð–Ð´ÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ deployment
        echo "â³ Waiting for deployment to be ready..."
        kubectl wait --for=condition=available --timeout=120s deployment/test-lockbox-app -n lockbox-demo
        
        # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
        echo ""
        echo "ðŸ“Š Deployment status:"
        kubectl get deployments -n lockbox-demo
        kubectl get pods -n lockbox-demo
        kubectl get services -n lockbox-demo
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ
        echo ""
        echo "ðŸŒ Testing application access..."
        NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}')
        echo "Node External IP: $NODE_IP"
        echo "Service URL: http://$NODE_IP:30090"
        
        # Ð”ÐµÐ»Ð°ÐµÐ¼ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
        for i in {1..10}; do
          if curl -f http://$NODE_IP:30090/health; then
            echo ""
            echo "ðŸŽ‰ SUCCESS! Application is deployed and accessible!"
            echo "   Health check passed!"
            break
          else
            echo "â³ Attempt $i/10: Application not ready yet..."
            sleep 10
          fi
        done
    
    - name: Cleanup test resources (optional)
      if: always()
      run: |
        echo "ðŸ§¹ Optional cleanup..."
        echo "To cleanup manually, run:"
        echo "kubectl delete namespace lockbox-demo"
    
    - name: Success message
      if: success()
      run: |
        echo ""
        echo "=========================================="
        echo "âœ… LOCKBOX INTEGRATION TEST PASSED!"
        echo "=========================================="
        echo ""
        echo "ðŸŽ‰ What was tested and verified:"
        echo "1. âœ… GitHub Secrets access (YC_SERVICE_ACCOUNT_KEY)"
        echo "2. âœ… Yandex Lockbox access (YC_LOCKBOX_SECRET_ID)"
        echo "3. âœ… Secrets retrieval from Lockbox"
        echo "4. âœ… Docker build and push to Yandex Registry"
        echo "5. âœ… Kubernetes cluster access"
        echo "6. âœ… Deployment to Yandex Managed Kubernetes"
        echo "7. âœ… Application health check"
        echo ""
        echo "ðŸ”§ Tested infrastructure:"
        echo "   â€¢ Lockbox Secret: ci-cd-secrets"
        echo "   â€¢ Registry: cr-ci-demo"
        echo "   â€¢ Kubernetes: k8s-ci-demo"
        echo "   â€¢ PostgreSQL: pg-ci-demo"
        echo ""
        echo "ðŸ“Š Deployment details:"
        echo "   â€¢ Namespace: lockbox-demo"
        echo "   â€¢ Deployment: test-lockbox-app"
        echo "   â€¢ Service: test-lockbox-service"
        echo "   â€¢ Port: 30090"
